<!DOCTYPE html>
<html><head>
<title>RDMA Programming</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="RDMA Operations and Verbs(API)">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">















  






      <script src="/js/toc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">

<link rel="stylesheet" href="/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css" integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">



















</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Blogs
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    About Me
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#1-rdma" class="nav-1-rdma">
									1. RDMA
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#bypassing-os" class="nav-bypassing-os">
									Bypassing OS
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#memory-zero-copy" class="nav-memory-zero-copy">
									Memory Zero-copy
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#2-rdma-verbs" class="nav-2-rdma-verbs">
									2. RDMA Verbs
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#rdma---memory-registration" class="nav-rdma---memory-registration">
									RDMA - Memory Registration
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#sendreceive-operation" class="nav-sendreceive-operation">
									Send/Receive Operation
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-write-operationone-sided" class="nav-rdma-write-operationone-sided">
									RDMA Write Operation(One-sided)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-read-operationone-sided" class="nav-rdma-read-operationone-sided">
									RDMA Read Operation(One-sided)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#atomic-operations" class="nav-atomic-operations">
									Atomic Operations
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#3-rdma-code-example" class="nav-3-rdma-code-example">
									3. RDMA Code Example
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#memory-registration" class="nav-memory-registration">
									Memory Registration
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-send-request" class="nav-rdma-send-request">
									RDMA Send Request
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-receive-request" class="nav-rdma-receive-request">
									RDMA Receive Request
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-request-completion" class="nav-rdma-request-completion">
									RDMA Request Completion
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#4-connection-establishment" class="nav-4-connection-establishment">
									4. Connection Establishment
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#rdma-cm-connection-manager" class="nav-rdma-cm-connection-manager">
									RDMA CM (Connection Manager)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#5-rcpingpong" class="nav-5-rcpingpong">
									5. RCpingpong
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://yuhaolu.github.io/">
            Yuhao&#39;s Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://yuhaolu.github.io/">
        <div class="single-column-header-title">Yuhao&#39;s Blog</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    RDMA Programming
                    
                    <div class="post-subtitle">
                        RDMA Operations and Verbs(API)
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2024-07-05 16:09
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/network">Network</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/network">Network</a>
                                &nbsp;
                            
                                <a href="/tags/rdma">RDMA</a>
                                &nbsp;
                            
                                <a href="/tags/coursera">Coursera</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <p>Ref: <a href="https://www.coursera.org/learn/the-fundamentals-of-rdma-programming">https://www.coursera.org/learn/the-fundamentals-of-rdma-programming</a></p>
<h1 id="1-rdma">1. RDMA</h1>
<h2 id="bypassing-os">Bypassing OS</h2>
<p>Traditionally, most socket application uses the socket API, for example, connect, accept, send and receive. All our functions are used to pass data from one point to another.</p>
<ul>
<li>Client
<ul>
<li>connect()</li>
<li>send()</li>
<li>recv()</li>
</ul>
</li>
<li>Server
<ul>
<li>accept()</li>
<li>send()</li>
<li>recv()</li>
</ul>
</li>
</ul>
<p>RDMA programming is an alternative to socket programming. It gives you better latency and better utilization of your hardware if you have network interface cards that can work with it.</p>
<ol>
<li>
<p>Transport Offload</p>
<ul>
<li>Reliable Connection(RC)</li>
<li>Unreliable Datagram(UD)</li>
</ul>
<table>
<thead>
<tr>
<th>Transport Layer</th>
<th>RC is like TCP</th>
<th>UD is like UDP</th>
</tr>
</thead>
<tbody>
<tr>
<td>Reliability</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Connectivity</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Message/Stream</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Kernel Bypass</p>
</li>
</ol>
<pre tabindex="0"><code>      Socket Programs            RDMA Program
      Application
User  Socket Libarary            RDMA Library
----------------------          -----------------
OS    Socket TCP/IP
      Device Driver
----------------------
      NIC Hardware               NIC Hardware
</code></pre><p><img src="/images/RDMA_Programming/RDMA_zero_copy.png" alt="static"></p>
<h2 id="memory-zero-copy">Memory Zero-copy</h2>
<p><img src="/images/RDMA_Programming/transfer_flight.png" alt="static"></p>
<ul>
<li>Buffer Copy
<ul>
<li>two sided</li>
<li>send</li>
<li>Temporary buffers</li>
<li>Additional copies</li>
</ul>
</li>
<li>Zero Copy
<ul>
<li>one sided</li>
<li>RDMA read/write</li>
<li>Transfer directly</li>
<li>No additional copies</li>
</ul>
</li>
</ul>
<h1 id="2-rdma-verbs">2. RDMA Verbs</h1>
<p>Verbs {API}</p>
<ul>
<li>
<p>Control Path</p>
<ul>
<li>Create</li>
<li>Modify</li>
<li>Destroy</li>
<li>Query</li>
<li>Work with Events</li>
</ul>
</li>
<li>
<p>Data Path</p>
<ul>
<li>Post Send</li>
<li>Post Receive</li>
<li>Poll CQ</li>
<li>Request for completion event</li>
</ul>
</li>
<li>
<p>Libibverbs - User Space Library</p>
<ul>
<li>Send/Receive</li>
<li>QP Create Destroy</li>
<li>Init Query Teardown</li>
</ul>
</li>
<li>
<p>Kernel Verbs</p>
</li>
</ul>
<p>Verbs</p>
<ol>
<li>Request</li>
<li>Completions</li>
<li>Queues</li>
</ol>
<p><img src="/images/RDMA_Programming/RDMA_datapath_flow.png" alt="static"></p>
<p>RDMA verbs typically divide into</p>
<ul>
<li>Data Path, which governs how data is sent and/or received</li>
<li>Control Path, which governs how resources are created, modified or destroyed</li>
</ul>
<h3 id="rdma---memory-registration">RDMA - Memory Registration</h3>
<p>Operation systems, typically include virtual memory management.
Hardware has its finite number of resources, which includes physical memory. While each process has a range of virtual memory dedicated for its use. In almost every case, the number of processes, time, the size of the virtual memory for each process, is much bigger than the size of the actual physical memory available on the system. For example, if we take 32-bit system, the size of the virtual memory for each process is 4 Gbytes. The operation system is responsible for mapping that physical memory it has to the virtual memory in the processes.</p>
<p><img src="/images/RDMA_Programming/VM_Management.png" alt="static"></p>
<p>Now, the user-level software, which are most applications, only use virtual memory addresses. Some of the virtual memory range, is allocated and available for use, while the rest is vacant. Now, the applications can only access allocated memory. If we access vacant addresses, we get a segmentation fault. Addresses also have permissions like read, write, or the ability to execute code. When they allocate memory, the operation system takes the physical memory and maps it to a vacant space in our virtual addresses.</p>
<ol>
<li>Protection &amp; Permission (RW)</li>
<li>Memory Pinning(physical locking of memory)</li>
<li>Translation Handling</li>
</ol>
<p>Verbs can only send or receive to registered memory. Memory registration typically happens in the beginning of the application, and it is used throughout the run.</p>
<h3 id="sendreceive-operation">Send/Receive Operation</h3>
<pre tabindex="0"><code>

     Sender          Receiver
        |               |
Post SR |  \_data_      |  Post RR
        |         \-&gt;   |
        |           /   |
        |     -Ack--    |  Poll CQ
Poll CQ |  &lt;-/          |
        |               |
</code></pre><h3 id="rdma-write-operationone-sided">RDMA Write Operation(One-sided)</h3>
<pre tabindex="0"><code>     Sender                             Receiver
        |                                   |
Post SR |  \_____data+addr+rkey______       |  
        |                             \-&gt;   |
        |                             /     |
        |     -----------Ack---------       |  
        |  &lt;-/ (in Reliable Transports)     |
Poll CQ |                                   |
        |                                   |
</code></pre><h3 id="rdma-read-operationone-sided">RDMA Read Operation(One-sided)</h3>
<pre tabindex="0"><code>     Sender                             Receiver
        |                                   |
Post SR |  \_____data+addr+rkey______       |  
        |                             \-&gt;   |
        |                             /     |
        |     ----------data---------       |  
        |  &lt;-/ (in Reliable Transports)     |
Poll CQ |                                   |
        |                                   |
</code></pre><h3 id="atomic-operations">Atomic Operations</h3>
<ol>
<li>Fetch and Add(FAA): fetch the current value of a number, then increase it by a different number.ex. Multiple Cashier</li>
<li>Compare and Swap(CAS): compare the current value and if it matches, we replace it with a different value.
ex. Multiple withdraw from same bank account</li>
</ol>
<h1 id="3-rdma-code-example">3. RDMA Code Example</h1>
<h2 id="memory-registration">Memory Registration</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define size_t int 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> ibv_pd <span style="color:#f92672">*</span>pd;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> ibv_mr <span style="color:#f92672">*</span>mr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Memory Reg Example
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> ibv_mr <span style="color:#f92672">*</span><span style="color:#a6e22e">ibv_reg_mr</span>(<span style="color:#66d9ef">struct</span> ibv_pd <span style="color:#f92672">*</span>pd,
</span></span><span style="display:flex;"><span>					    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr, <span style="color:#66d9ef">size_t</span> length,
</span></span><span style="display:flex;"><span>					    <span style="color:#66d9ef">enum</span> ibv_access_flags access); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Notice the following fields in struct ibv_mr:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">rkey  - The remote key of this MR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">lkey  - The local key of this MR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">addr “ The start address of the memory buffer that this MR registered
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">length “ The size of the memory buffer that was registered
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Deregister a Memory Region
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ibv_dereg_mr</span>(<span style="color:#66d9ef">struct</span> ibv_mr <span style="color:#f92672">*</span>mr); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">This verb should be called if there is no outstanding 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Send Request or Receive Request that points to it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="rdma-send-request">RDMA Send Request</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define size_t int 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define uint64_t int
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define uint32_t int
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> ibv_pd <span style="color:#f92672">*</span>pd;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> ibv_mr <span style="color:#f92672">*</span>mr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Scatter Gather Entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> ibv_sge {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint64_t</span> addr; <span style="color:#75715e">// Start address of the memory buffer (registered memory)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">uint32_t</span> length; <span style="color:#75715e">// Size (in bytes) of the memory buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">uint32_t</span> lkey;   <span style="color:#75715e">// lkey of Memory Region associated with this memory buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Post Send
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ibv_post_send</span>(<span style="color:#66d9ef">struct</span> ibv_qp <span style="color:#f92672">*</span>qp, <span style="color:#66d9ef">struct</span> ibv_send_wr <span style="color:#f92672">*</span>wr,
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">struct</span> ibv_send_wr <span style="color:#f92672">**</span>bad_wr);  <span style="color:#75715e">// wr - work request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> ibv_send_wr {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint64_t</span> wr_id;            <span style="color:#75715e">// Private context that will be available in the corresponding Work Completion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> ibv_send_wr <span style="color:#f92672">*</span>next;  <span style="color:#75715e">// Address of the next Send Request. NULL in the last Send Request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> ibv_sge <span style="color:#f92672">*</span>sg_list;   <span style="color:#75715e">// Array of scatter/gather elements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> num_sge;               <span style="color:#75715e">// Number of elements in sg_list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">enum</span> ibv_wr_opcode opcode; <span style="color:#75715e">// The opcode to be used
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> send_flags;            <span style="color:#75715e">// Send flags. Or of the following flags:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* IBV_SEND_FENCE “ Prevent process this Send Request until the processing of previous RDMA 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    //                   Read and Atomic operations were completed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    //IBV_SEND_SIGNALED “ Generate a Work Completion after processing of this Send Request ends
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    //IBV_SEND_SOLICITED “ Generate Solicited event for this message in remote side
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    IBV_SEND_INLINE  - allow the low-level driver to read the gather buffers*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint32_t</span> imm_data;  <span style="color:#75715e">// Send message with immediate data (for supported opcodes)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">struct</span> {                           <span style="color:#75715e">// Attributes for RDMA Read and write opcodes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">uint64_t</span> remote_addr;      <span style="color:#75715e">// Remote start address (the message size is according to the S/G entries)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">uint32_t</span> rkey;             <span style="color:#75715e">// rkey of Memory Region that is associated with remote memory buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        } rdma;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">struct</span> {                           <span style="color:#75715e">// Attributes for Atomic opcodes 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">uint64_t</span> remote_addr;      <span style="color:#75715e">// Remote start address (the message size is according to the S/G entries)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">uint64_t</span> compare_add;      <span style="color:#75715e">// Value to compare/add (depends on opcode)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">uint64_t</span> swap;             <span style="color:#75715e">// Value to swap if the comparison passed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">uint32_t</span> rkey;             <span style="color:#75715e">// rkey of Memory Region that is associated with remote memory buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        } atomic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="rdma-receive-request">RDMA Receive Request</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">//Post Receive Request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ibv_post_recv</span>(<span style="color:#66d9ef">struct</span> ibv_qp <span style="color:#f92672">*</span>qp, <span style="color:#66d9ef">struct</span> ibv_recv_wr <span style="color:#f92672">*</span>wr,
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">struct</span> ibv_recv_wr <span style="color:#f92672">**</span>bad_wr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Post Send Request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ibv_post_send</span>(<span style="color:#66d9ef">struct</span> ibv_qp <span style="color:#f92672">*</span>qp, <span style="color:#66d9ef">struct</span> ibv_send_wr <span style="color:#f92672">*</span>wr,
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">struct</span> ibv_send_wr <span style="color:#f92672">**</span>bad_wr);            
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Warning: bad_wr is mandatory; It will be assigned with the address of 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">the Receive Request that its posting failed */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> ibv_recv_wr {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint64_t</span> wr_id;           <span style="color:#75715e">// Private context, available in the corresponding Work Completion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> ibv_recv_wr <span style="color:#f92672">*</span>next; <span style="color:#75715e">// Address of the next Receive Request. NULL in the last Request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> ibv_sge <span style="color:#f92672">*</span>sg_list;  <span style="color:#75715e">// Array of scatter elements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> num_sge;              <span style="color:#75715e">// Number of elements in sg_list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><h2 id="rdma-request-completion">RDMA Request Completion</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Polling for work completion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ibv_poll_cq</span>(<span style="color:#66d9ef">struct</span> ibv_cq <span style="color:#f92672">*</span>cq, <span style="color:#66d9ef">int</span> num_entries, <span style="color:#66d9ef">struct</span> ibv_wc <span style="color:#f92672">*</span>wc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Work Completion for each entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> ibv_wc {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint64_t</span> wr_id;                <span style="color:#75715e">// Private context that was posted in the corresponding Work Request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">enum</span> ibv_wc_status status;     <span style="color:#75715e">// The status of the Work Completion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">enum</span> ibv_wc_opcode opcode;     <span style="color:#75715e">// The opcode of the Work Completion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">uint32_t</span> vendor_err;           <span style="color:#75715e">// Vendor specific error syndrome
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">uint32_t</span> byte_len;             <span style="color:#75715e">// Number of bytes that were received
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">uint32_t</span> imm_data;             <span style="color:#75715e">// Immediate data, in network order, if the flags indicate that such exists
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">uint32_t</span> qp_num;               <span style="color:#75715e">// The local QP number that this Work Completion ended in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">uint32_t</span> src_qp;               <span style="color:#75715e">// The remote QP number
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> wc_flags;                  <span style="color:#75715e">// Work Completion flags. Or of the following flags:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/* IBV_WC_GRH “ Indicator that the first 40 bytes of the receive buffer(s) contain a valid GRH
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      IBV_WC_WITH_IMM “ Indicator that the received message contains immediate data */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint16_t</span> pkey_index;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint16_t</span> slid;                                <span style="color:#75715e">// For UD QP: the source LID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">uint8_t</span> sl;                                     <span style="color:#75715e">// For UD QP: the source Service Level
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">uint8_t</span> dlid_path_bits;                      <span style="color:#75715e">// For UD QP: the destination LID path bits
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// typical completion statuses
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// IBV_WC_SUCCESS “ Operation completed successfully
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// IBV_WC_LOC_LEN_ERR “ Local length error when processing SR or RR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// IBV_WC_LOC_PROT_ERR “ Local Protection error; S/G entries doesn&#39;t point to a valid MR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// IBV_WC_WR_FLUSH_ERR “ Work Request flush error; it was processed when the QP was in Error state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// IBV_WC_RETRY_EXC_ERR “ Retry exceeded; the remote QP didn™t send any ACK/NACK, even after
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//             message retransmission                                                                      
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// IBV_WC_RNR_RETRY_EXC_ERR “ Receiver Not Ready; a message that requires a Receive Request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//            was sent, but isn&#39;t any RR in the remote QP, even after message retransmission
</span></span></span></code></pre></div><h1 id="4-connection-establishment">4. Connection Establishment</h1>
<p>We saw some RDMA code examples, but we cannot really use those before we establish an initial connection with the other side.</p>
<p>Connection-oriented transports require a connection establishment between the two hosts before the data could be sent. So each side needs to have the opposite side address to establish the connection. And that leaves us with a chicken and egg problem. On the one hand, we need the address information in order to create a connection, but we also need some sort of connection to exchange those addresses.</p>
<p>This problem has two solutions.</p>
<ol>
<li>First, is out-of-band communication. It means we use different type of transport to exchange the addresses and then create the RDMA connection. For example, RC-ping-pong using TCP sockets to exchange information, like the remote QP number.</li>
<li>The second solution is Communication Manager. Two of its services are address exchange and a connection establishment. Now, the following information has to be exchanged before we can form a connection.
<ul>
<li>Layer2 &amp; Layer3 addresses:
<ul>
<li>local identifier(LID): MAC</li>
<li>global identifier(GID): IP</li>
</ul>
</li>
<li>QP numbers: similar to TCP port</li>
<li>Packet Serial Number: sequence number in TCP</li>
<li>Communication details, ex. MTU</li>
<li>Additional info, ex. remote keys for registered buffers</li>
<li>Different transport types require further info, ex. RC QPs require the transmission count and the timer value.</li>
</ul>
</li>
</ol>
<h2 id="rdma-cm-connection-manager">RDMA CM (Connection Manager)</h2>
<p>API is designed simlar to server-client in TCP.
Like in TCP, in order to establish a connection, the server needs to bind and listen on the port. The client needs to connect to that port. Once the connection is established, you can either use the RDMA CM API or verbs API to communicate in that connection. So you either call RDMA post send or IBV post send.</p>
<p>Functions:</p>
<ul>
<li>(server)
<ul>
<li>rdma_bind_addr():  set the local port number to listen on</li>
<li>rdma_listen(): begin listening for connection requests</li>
<li>rdma_accept(): accept the connection request</li>
</ul>
</li>
<li>(client)
<ul>
<li>rdma_connect(): connect to the remote server</li>
</ul>
</li>
</ul>
<p>Verb Specific:</p>
<ul>
<li>rdma_create_qp(): allocate a QP for the communication on the new rdma_cm_id</li>
<li>rdma_post_send(): post a buffer to send a message</li>
</ul>
<h1 id="5-rcpingpong">5. RCpingpong</h1>


    
    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/IlLXEgu9Nzs?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"
      ></iframe>
    </div>


                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2024-07-05</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/posts/algo/hashing/">
			&lt; Next<br>Hashing
                </a>
                
                
                
                <a class="older-posts" href="/posts/cs/ml_stanford/">
			Previous &gt;<br>Machine Learning
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                












            </div>
        </div>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://yuhaolu.github.io/">
    
        <div class="nav-title">
            Yuhao&#39;s Blog
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Blogs
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                About Me
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
<a href="https://linkedin.com/in/yuhao-lu-dev/">
    <img src="/images/icons/linkedin.png" alt="Linkedin" width="22px" height="22px" style="margin-right: 8px;">
</a>
<a href="https://github.com/YuhaoLu">
    <img src="/images/icons/github.webp" alt="Github" width="22px" height="22px" style="margin-right: 8px;">
</a>

<p></p>
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> 
<br>



&copy;
	
	2025 Yuhao&#39;s Blog
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
        <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#1-rdma" class="nav-1-rdma">
									1. RDMA
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#bypassing-os" class="nav-bypassing-os">
									Bypassing OS
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#memory-zero-copy" class="nav-memory-zero-copy">
									Memory Zero-copy
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#2-rdma-verbs" class="nav-2-rdma-verbs">
									2. RDMA Verbs
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#rdma---memory-registration" class="nav-rdma---memory-registration">
									RDMA - Memory Registration
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#sendreceive-operation" class="nav-sendreceive-operation">
									Send/Receive Operation
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-write-operationone-sided" class="nav-rdma-write-operationone-sided">
									RDMA Write Operation(One-sided)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-read-operationone-sided" class="nav-rdma-read-operationone-sided">
									RDMA Read Operation(One-sided)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#atomic-operations" class="nav-atomic-operations">
									Atomic Operations
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#3-rdma-code-example" class="nav-3-rdma-code-example">
									3. RDMA Code Example
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#memory-registration" class="nav-memory-registration">
									Memory Registration
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-send-request" class="nav-rdma-send-request">
									RDMA Send Request
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-receive-request" class="nav-rdma-receive-request">
									RDMA Receive Request
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rdma-request-completion" class="nav-rdma-request-completion">
									RDMA Request Completion
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#4-connection-establishment" class="nav-4-connection-establishment">
									4. Connection Establishment
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#rdma-cm-connection-manager" class="nav-rdma-cm-connection-manager">
									RDMA CM (Connection Manager)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#5-rcpingpong" class="nav-5-rcpingpong">
									5. RCpingpong
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>

<div id="single-column-footer">
<a href="https://linkedin.com/in/yuhao-lu-dev/">
    <img src="/images/icons/linkedin.png" alt="Linkedin" width="22px" height="22px" style="margin-right: 8px;">
</a>
<a href="https://github.com/YuhaoLu">
    <img src="/images/icons/github.webp" alt="Github" width="22px" height="22px" style="margin-right: 8px;">
</a>

<p></p>
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> 
<br>



&copy;
	
	2025 Yuhao&#39;s Blog
	
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
